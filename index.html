```html
                                            <option value="">Select</option>
                                            <option value="Nil">Nil</option>
                                            <option value="Present">Present</option>
                                        </select>
                                    </td>
                                    <td class="normal-range">${section.tests["Undigested Muscle Fibers"] || ''}</td>
                                </tr>
                                <tr>
                                    <td class="test-name">Yeast Cells</td>
                                    <td>
                                        <select class="result-select">
                                            <option value="">Select</option>
                                            <option value="Nil">Nil</option>
                                            <option value="Present">Present</option>
                                        </select>
                                    </td>
                                    <td class="normal-range">${section.tests["Yeast Cells"] || ''}</td>
                                </tr>
                                <tr>
                                    <td class="test-name">Occult Blood</td>
                                    <td>
                                        <select class="result-select">
                                            <option value="">Select</option>
                                            <option value="Negative">Negative</option>
                                            <option value="Positive">Positive</option>
                                        </select>
                                    </td>
                                    <td class="normal-range">${section.tests["Occult Blood"] || ''}</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                } 
                // التعامل الخاص مع أقسام التحاليل المناعية والفيروسية
                else if (section.id === 'serologySection' || section.id === 'viralSection') {
                    tableHTML += `<table><tr><th>Test</th><th>Result</th><th>Normal Range</th></tr>`;
                    for (const testName in section.tests) {
                        let resultInputHTML;
                        const serologyTests = ['Salmonella typhi', 'Salmonella typhi IgG', 'Salmonella typhi IgM', 'Rose Bengal (Brucella)', 'H.pylori Ab', 'Rheumatoid Factor', 'Toxoplasma IgG', 'Toxoplasma IgM', 'CMV IgG', 'CMV IgM', 'EBV (VCA IgG)', 'EBV (VCA IgM)', 'HBsAg', 'HBsAb', 'Anti-HCV (HCV-Ab)', 'HIV AB', 'HIV (ELISA)', 'VDRL / RPR (Syphilis)', 'ANA', 'Anti-dsDNA', 'Hepatitis A virus (HAV) IgM', 'Hepatitis A virus (HAV) IgG', 'Hepatitis B virus (HBV) DNA', 'Hepatitis C virus (HCV) RNA', 'Epstein-Barr virus (EBV)', 'Herpes Simplex Virus 1/2 (HSV-1/2) IgG', 'Herpes Simplex Virus 1/2 (HSV-1/2) IgM', 'HIV 1/2 Ab', 'HIV p24 Ag', 'Measles IgG', 'Measles IgM', 'Mumps IgG', 'Mumps IgM'];
                        
                        if (serologyTests.includes(testName)) {
                            resultInputHTML = `<td><select class="result-select"><option value="">Select</option><option value="Positive">Positive</option><option value="Negative">Negative</option></select></td>`;
                        } else {
                            resultInputHTML = `<td><input type="text" class="result-input"></td>`;
                        }

                        tableHTML += `
                            <tr>
                                <td class="test-name">${testName}</td>
                                ${resultInputHTML}
                                <td class="normal-range">${section.tests[testName] || ''}</td>
                            </tr>
                        `;
                    }
                    tableHTML += `</table>`;
                } 
                // الأقسام العادية
                else {
                    tableHTML += `<table><tr><th>Test</th><th>Result</th><th>Normal Range</th></tr>`;
                    for (const testName in section.tests) {
                        tableHTML += `
                            <tr>
                                <td class="test-name">${testName}</td>
                                <td><input type="text" class="result-input"></td>
                                <td class="normal-range">${section.tests[testName] || ''}</td>
                            </tr>
                        `;
                    }
                    tableHTML += `</table>`;
                }
                
                sectionDiv.innerHTML = tableHTML;
                resultsContainer.appendChild(sectionDiv);
            });
            
            showSelectedSection();
        }

        function updateSelectMenus() {
            const testSelect = document.getElementById('test-select');
            const sectionSelectModal = document.getElementById('sectionSelect');
            const sectionForNewTestSelect = document.getElementById('existing-sections');
            
            testSelect.innerHTML = '<option value="">اختر قسم...</option>';
            if (sectionSelectModal) sectionSelectModal.innerHTML = '<option value="">اختر قسم...</option>';
            if (sectionForNewTestSelect) sectionForNewTestSelect.innerHTML = '<option value="">اختر قسم...</option>';
            
            labStructure.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.title;
                testSelect.appendChild(option.cloneNode(true));
                
                if (sectionSelectModal) {
                    const option2 = option.cloneNode(true);
                    sectionSelectModal.appendChild(option2);
                }
                
                if (sectionForNewTestSelect) {
                    const option3 = option.cloneNode(true);
                    sectionForNewTestSelect.appendChild(option3);
                }
            });
            
            populateExistingSections();
        }

        // دوال إدارة النطاقات
        function openRangeManager() {
            document.getElementById('rangeModal').style.display = 'block';
            updateSelectMenus();
            loadSectionRanges();
        }

        function closeRangeManager() {
            document.getElementById('rangeModal').style.display = 'none';
        }

        function loadSectionRanges() {
            const sectionId = document.getElementById('sectionSelect').value;
            if (!sectionId) {
                document.getElementById('rangeTableContainer').innerHTML = '<p>يرجى اختيار قسم لعرض التحاليل</p>';
                return;
            }
            
            const selectedSection = labStructure.find(sec => sec.id === sectionId);
            if (!selectedSection) {
                document.getElementById('rangeTableContainer').innerHTML = '<p>القسم غير موجود</p>';
                return;
            }

            let tableHTML = `
                <table class="range-table">
                    <tr>
                        <th>اسم التحليل</th>
                        <th>النطاق الطبيعي</th>
                        <th>إجراءات</th>
                    </tr>
            `;
            
            for (const testName in selectedSection.tests) {
                tableHTML += `
                    <tr>
                        <td>${testName}</td>
                        <td>
                            <input type="text" class="normal-range-input" 
                                data-section="${sectionId}" 
                                data-test="${testName}" 
                                value="${selectedSection.tests[testName] || ''}">
                        </td>
                        <td>
                            <button class="btn btn-clear" onclick="removeTest('${sectionId}', '${testName}')" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `</table>`;
            document.getElementById('rangeTableContainer').innerHTML = tableHTML;
        }

        function saveRanges() {
            const inputs = document.querySelectorAll('#rangeTableContainer .normal-range-input');
            const customRanges = JSON.parse(localStorage.getItem('customTests')) || {};

            inputs.forEach(input => {
                const sectionId = input.dataset.section;
                const testName = input.dataset.test;
                const rangeValue = input.value.trim();

                const section = labStructure.find(sec => sec.id === sectionId);
                if (section) {
                    section.tests[testName] = rangeValue;
                }
                
                if (!customRanges[sectionId]) {
                    customRanges[sectionId] = [];
                }
                const existingTest = customRanges[sectionId].find(test => test.name === testName);
                if (existingTest) {
                    existingTest.range = rangeValue;
                } else {
                    customRanges[sectionId].push({ name: testName, range: rangeValue });
                }
            });

            localStorage.setItem('customTests', JSON.stringify(customRanges));
            loadLabStructure();
            alert('تم حفظ النطاقات الطبيعية بنجاح!');
            closeRangeManager();
        }

        function removeTest(sectionId, testName) {
            if (confirm(`هل تريد حذف التحليل "${testName}"؟`)) {
                const section = labStructure.find(sec => sec.id === sectionId);
                if (section) {
                    delete section.tests[testName];
                    
                    // تحديث localStorage
                    let customTests = JSON.parse(localStorage.getItem('customTests')) || {};
                    if (customTests[sectionId]) {
                        customTests[sectionId] = customTests[sectionId].filter(test => test.name !== testName);
                        if (customTests[sectionId].length === 0) {
                            delete customTests[sectionId];
                        }
                        localStorage.setItem('customTests', JSON.stringify(customTests));
                    }
                    
                    loadLabStructure();
                    loadSectionRanges();
                    alert('تم حذف التحليل بنجاح!');
                }
            }
        }

        // دوال إدارة الأقسام والتحاليل الجديدة
        function openAddSectionModal() {
            document.getElementById('addSectionModal').style.display = 'block';
            populateExistingSections();
        }

        function closeAddSectionModal() {
            document.getElementById('addSectionModal').style.display = 'none';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            const activeContent = document.getElementById(tabId);
            if (activeContent) activeContent.classList.add('active');
        }

        function addNewTestField() {
            const newTestHTML = `
                <div class="test-item">
                    <input type="text" class="form-input test-name-input" placeholder="اسم التحليل">
                    <input type="text" class="form-input test-range-input" placeholder="النطاق الطبيعي">
                    <span class="remove-test" onclick="removeNewTest(this)">×</span>
                </div>
            `;
            document.getElementById('new-section-tests').insertAdjacentHTML('beforeend', newTestHTML);
        }

        function removeNewTest(element) {
            element.parentElement.remove();
        }

        function saveNewSection() {
            const sectionName = document.getElementById('new-section-name').value.trim();
            const sectionIcon = document.getElementById('new-section-icon').value;
            
            if (!sectionName) {
                alert('يرجى إدخال اسم للقسم الجديد.');
                return;
            }
            
            const sectionId = 'customSection_' + Date.now();
            const testInputs = document.querySelectorAll('#new-section-tests .test-item');
            const tests = [];
            
            testInputs.forEach(testItem => {
                const nameInput = testItem.querySelector('.test-name-input');
                const rangeInput = testItem.querySelector('.test-range-input');
                
                if (nameInput.value.trim() && rangeInput.value.trim()) {
                    tests.push({
                        name: nameInput.value.trim(),
                        range: rangeInput.value.trim()
                    });
                }
            });
            
            if (tests.length === 0) {
                alert('يرجى إدخال تحليل واحد على الأقل للقسم الجديد.');
                return;
            }
            
            let customSections = JSON.parse(localStorage.getItem('customSections')) || {};
            customSections[sectionId] = {
                name: sectionName,
                icon: sectionIcon,
                tests: tests
            };
            localStorage.setItem('customSections', JSON.stringify(customSections));
            
            loadLabStructure();
            
            document.getElementById('new-section-name').value = '';
            document.getElementById('new-section-tests').innerHTML = `
                <div class="test-item">
                    <input type="text" class="form-input test-name-input" placeholder="اسم التحليل">
                    <input type="text" class="form-input test-range-input" placeholder="النطاق الطبيعي">
                    <span class="remove-test" onclick="removeNewTest(this)">×</span>
                </div>
            `;
            
            alert('تم إضافة القسم الجديد بنجاح!');
            closeAddSectionModal();
        }

        function populateExistingSections() {
            const existingSectionsSelect = document.getElementById('existing-sections');
            if (!existingSectionsSelect) return;
            
            existingSectionsSelect.innerHTML = '<option value="">اختر قسم...</option>';
            
            labStructure.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.title;
                existingSectionsSelect.appendChild(option);
            });
        }

        function saveNewTest() {
            const sectionId = document.getElementById('existing-sections').value;
            const testName = document.getElementById('new-test-name').value.trim();
            const testRange = document.getElementById('new-test-range').value.trim();
            
            if (!sectionId || !testName || !testRange) {
                alert('يرجى إدخال اسم القسم واسم التحليل والنطاق الطبيعي.');
                return;
            }
            
            // التحقق من عدم تكرار التحليل
            const selectedSection = labStructure.find(sec => sec.id === sectionId);
            if (selectedSection && selectedSection.tests[testName]) {
                alert('هذا التحليل موجود بالفعل في هذا القسم.');
                return;
            }
            
            let customTests = JSON.parse(localStorage.getItem('customTests')) || {};
            if (!customTests[sectionId]) {
                customTests[sectionId] = [];
            }
            
            // التحقق من عدم التكرار في التحاليل المخصصة
            const existingTest = customTests[sectionId].find(test => test.name === testName);
            if (existingTest) {
                alert('هذا التحليل موجود بالفعل.');
                return;
            }
            
            customTests[sectionId].push({ name: testName, range: testRange });
            localStorage.setItem('customTests', JSON.stringify(customTests));
            
            loadLabStructure();
            
            // إعادة تعيين النموذج
            document.getElementById('new-test-name').value = '';
            document.getElementById('new-test-range').value = '';
            document.getElementById('existing-sections').selectedIndex = 0;
            
            alert('تم إضافة التحليل الجديد بنجاح!');
        }

        // دوال إدارة بيانات المريض
        function savePatientData() {
            const patientName = document.getElementById('patientName').value.trim();
            if (!patientName) {
                alert('يرجى إدخال اسم المريض أولاً.');
                return;
            }

            if (!db) {
                alert('قاعدة البيانات غير جاهزة. يرجى المحاولة مرة أخرى.');
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);

            const patientData = {
                patientName: patientName,
                patientAge: document.getElementById('patientAge').value,
                patientGender: document.getElementById('patientGender').value,
                currentDate: document.getElementById('currentDate').value,
                doctorName: document.getElementById('doctorName').value,
                examinerName: document.getElementById('examinerName').value,
                biologistSignature: document.getElementById('biologistSignature').value,
                issueDate: document.getElementById('issueDate').value,
                tests: {}
            };

            const allSections = document.querySelectorAll('.section');
            allSections.forEach(section => {
                const sectionId = section.id;
                patientData.tests[sectionId] = {};
                
                const rows = section.querySelectorAll('tr');
                rows.forEach(row => {
                    const testNameElement = row.querySelector('.test-name');
                    const resultInput = row.querySelector('.result-input, .result-select');

                    if (testNameElement && resultInput) {
                        const testName = testNameElement.textContent.trim();
                        const resultValue = resultInput.value.trim();
                        if (resultValue) {
                            patientData.tests[sectionId][testName] = resultValue;
                        }
                    }
                });
            });

            const request = store.put(patientData);

            request.onsuccess = () => {
                alert('تم حفظ بيانات المريض بنجاح!');
            };

            request.onerror = (event) => {
                console.error("خطأ في الحفظ:", event.target.error);
                alert('فشل في حفظ البيانات. يرجى المحاولة مرة أخرى.');
            };
        }

        function loadPatientData() {
            document.getElementById('searchModal').style.display = 'block';
        }

        function searchPatientData() {
            const patientName = document.getElementById('searchPatientName').value.trim();
            if (!patientName) {
                alert('يرجى إدخال اسم المريض للبحث.');
                return;
            }

            if (!db) {
                alert('قاعدة البيانات غير جاهزة.');
                return;
            }

            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(patientName);

            request.onsuccess = (event) => {
                const patientData = event.target.result;
                if (patientData) {
                    document.getElementById('patientName').value = patientData.patientName || '';
                    document.getElementById('patientAge').value = patientData.patientAge || '';
                    document.getElementById('patientGender').value = patientData.patientGender || '';
                    document.getElementById('currentDate').value = patientData.currentDate || '';
                    document.getElementById('doctorName').value = patientData.doctorName || '';
                    document.getElementById('examinerName').value = patientData.examinerName || '';
                    document.getElementById('biologistSignature').value = patientData.biologistSignature || '';
                    document.getElementById('issueDate').value = patientData.issueDate || '';

                    // مسح جميع النتائج أولاً
                    document.querySelectorAll('.result-input, .result-select').forEach(input => {
                        input.value = '';
                    });
                    
                    // استعادة النتائج
                    for (const sectionId in patientData.tests) {
                        const tests = patientData.tests[sectionId];
                        for (const testName in tests) {
                            const testRows = document.querySelectorAll('#' + sectionId + ' .test-name');
                            for (let row of testRows) {
                                if (row.textContent.trim() === testName) {
                                    const input = row.closest('tr').querySelector('.result-input, .result-select');
                                    if (input) {
                                        input.value = tests[testName];
                                    }
                                    break;
                                }
                            }
                        }
                    }

                    alert('تم استعادة بيانات المريض بنجاح!');
                    closeSearchModal();
                    updateFilledTests();
                } else {
                    alert('لم يتم العثور على بيانات لهذا المريض.');
                }
            };

            request.onerror = (event) => {
                console.error("خطأ في الاستعادة:", event.target.error);
                alert('فشل في استعادة البيانات.');
            };
        }

        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('searchPatientName').value = '';
        }

        // دوال العرض والطباعة
        function setCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            const dateString = now.toLocaleDateString('ar-SA', options);
            document.getElementById('currentDate').value = dateString;
        }

        function setIssueDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            };
            const dateString = now.toLocaleDateString('ar-SA', options);
            document.getElementById('issueDate').value = dateString;
        }

        function showSelectedSection() {
            const sections = document.querySelectorAll('.section');
            const selectedSectionId = document.getElementById('test-select').value;
            sections.forEach(section => {
                if (section.id === selectedSectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        function clearAllFields() {
            if(confirm('هل أنت متأكد من مسح جميع الحقول؟')) {
                const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
                inputs.forEach(input => {
                    if (input.id !== 'currentDate' && input.id !== 'issueDate') {
                        input.value = '';
                    }
                });
                
                const selects = document.querySelectorAll('select');
                selects.forEach(select => {
                    select.selectedIndex = 0;
                });
                
                setCurrentDate();
                setIssueDate();
                showSelectedSection();
                updateFilledTests();
                alert('تم مسح جميع الحقول بنجاح!');
            }
        }

        function prepareForPrint() {
            // إظهار جميع الأقسام للطباعة
            const allSections = document.querySelectorAll('.section');
            allSections.forEach(section => {
                section.classList.add('active');
            });

            // إخفاء الصفوف الفارغة
            const allResultInputs = document.querySelectorAll('.result-input, .result-select');
            allResultInputs.forEach(input => {
                const row = input.closest('tr');
                if ((input.value.trim() === '' || (input.tagName === 'SELECT' && input.selectedIndex === 0)) && row) {
                    row.classList.add('no-print-row');
                } else {
                    row.classList.remove('no-print-row');
                }
            });
            
            // إخفاء معلومات المريض الفارغة
            const patientInfoInputs = document.querySelectorAll('#patientInfoSection .editable-field');
            patientInfoInputs.forEach(input => {
                const infoItem = input.closest('.info-item');
                if (input.value.trim() === '' && infoItem) {
                    infoItem.classList.add('no-print-item');
                } else {
                    infoItem.classList.remove('no-print-item');
                }
            });
            
            // إخفاء الأقسام الفارغة بالكامل
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                const inputsInSection = section.querySelectorAll('input, select');
                let hasValue = false;
                
                inputsInSection.forEach(input => {
                    if (input.value.trim() !== '' || (input.tagName === 'SELECT' && input.selectedIndex > 0)) {
                        hasValue = true;
                    }
                });
                
                if (!hasValue) {
                    section.classList.add('no-print-section');
                } else {
                    section.classList.remove('no-print-section');
                }
            });
        }

        function restoreAfterPrint() {
            const hiddenElements = document.querySelectorAll('.no-print-row, .no-print-item, .no-print-section');
            hiddenElements.forEach(element => {
                element.classList.remove('no-print-row', 'no-print-item', 'no-print-section');
            });
            showSelectedSection();
        }

        function printPage() {
            if (!document.getElementById('patientName').value.trim()) {
                alert('يرجى إدخال اسم المريض قبل الطباعة.');
                return;
            }
            prepareForPrint();
            window.print();
        }

        function updateFilledTests() {
            const filledList = document.getElementById('filledTests');
            if (!filledList) return;
            
            const allResultInputs = document.querySelectorAll('.result-input, .result-select');
            let filledTests = [];

            allResultInputs.forEach(input => {
                const hasValue = input.value && input.value.trim() !== '' && 
                                (input.tagName !== 'SELECT' || input.selectedIndex > 0);
                
                if (hasValue) {
                    const row = input.closest('tr');
                    if (row) {
                        const testNameElement = row.querySelector('.test-name');
                        if (testNameElement) {
                            const testName = testNameElement.textContent.trim();
                            if (testName && !filledTests.includes(testName)) {
                                filledTests.push(testName);
                            }
                        }
                    }
                }
            });

            if (filledTests.length > 0) {
                filledList.innerHTML = `<i class="fas fa-check-circle"></i> التحاليل المكتملة: <strong>${filledTests.join(', ')}</strong> (${filledTests.length} تحليل)`;
                filledList.style.display = 'block';
                filledList.style.color = '#4CAF50';
            } else {
                filledList.style.display = 'none';
            }
        }

        // إضافة مستمع للطباعة
        if (window.matchMedia) {
            const mediaQueryList = window.matchMedia('print');
            mediaQueryList.addListener(function(mql) {
                if (!mql.matches) {
                    restoreAfterPrint();
                }
            });
        } else {
            window.onafterprint = restoreAfterPrint;
        }

        // إضافة مستمعين للنوافذ المنبثقة
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // إضافة مستمعين للخروج من النوافذ المنبثقة باستخدام ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                const settingsPanel = document.getElementById('settingsPanel');
                if (settingsPanel.style.display === 'block') {
                    toggleSettings();
                }
            }
        });

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين التاريخ الحالي
            setCurrentDate();
            setIssueDate();
            
            // تهيئة قاعدة البيانات
            initDb();
            
            // تحميل هيكل المختبر
            loadLabStructure();
            
            // تطبيق الإعدادات
            applySettings();
            
            // إضافة مستمعين للنتائج
            setTimeout(() => {
                document.querySelectorAll('.result-input, .result-select').forEach(input => {
                    input.addEventListener('input', updateFilledTests);
                    input.addEventListener('change', updateFilledTests);
                });
            }, 100);
        });
    </script>
</body>
</html>
